(self.webpackChunkwebsite=self.webpackChunkwebsite||[]).push([[8146],{20320:(t,e,a)=>{t.exports={srcSet:a.p+"images/20190724003-883aa872.webp 657w,"+a.p+"images/20190724003-758f034e.webp 480w",images:[{path:a.p+"images/20190724003-883aa872.webp",width:657,height:252},{path:a.p+"images/20190724003-758f034e.webp",width:480,height:184}],src:a.p+"images/20190724003-883aa872.webp",toString:function(){return a.p+"images/20190724003-883aa872.webp"},placeholder:"data:image/webp;base64,UklGRvgAAABXRUJQVlA4IOwAAACQBQCdASooABAAPlEgjESjoiEVVgA4BQSzgE6Zq7f/MwB2A1gW82na4KE6lSMVkGiq7+4lwAD+/mbuXVXgdfZ9Ey5iSeiIGcPpJZ399mbQ9gMNryDSb7VAe8k0Z8A64q2+vRWRdT5K1CGdKP7zeP3Gti0RAvF3PJ7bj9ilbiGrzUOehicGOUhNjTEqM9f76ACZtBqCt36A9gIW/e9G1AzBv8D8fqHmcNjRRKapSNapH4D9SOxXR11hvNaCEEADAu/8kfnGWDnFyy9wfYpHnodfftmsQlDENbhC9bonx5q8czsmPDO59pVevAAAAA==",width:657,height:252}},71647:(t,e,a)=>{t.exports={srcSet:a.p+"images/20190724004-a9b2b793.webp 1337w,"+a.p+"images/20190724004-60f16f49.webp 1200w,"+a.p+"images/20190724004-1e0160fc.webp 720w,"+a.p+"images/20190724004-779fc5c1.webp 480w",images:[{path:a.p+"images/20190724004-a9b2b793.webp",width:1337,height:878},{path:a.p+"images/20190724004-60f16f49.webp",width:1200,height:788},{path:a.p+"images/20190724004-1e0160fc.webp",width:720,height:473},{path:a.p+"images/20190724004-779fc5c1.webp",width:480,height:315}],src:a.p+"images/20190724004-a9b2b793.webp",toString:function(){return a.p+"images/20190724004-a9b2b793.webp"},placeholder:"data:image/webp;base64,UklGRv4BAABXRUJQVlA4IPIBAAAwCQCdASooABoAPlEgjkSjoiEStmQ4BQS2AFYZZeHz0a+buDW4/UjtgOfm9AHnM9Q7z5fsq+UyTRwQEQezhnnyx9RUsAbexk8PBFkPEisi/wv4AP7tLNVFtRmI+xPA3UR8r2kT9bETl2WyyZ9Nf6J25GrMiu4xAMWi8CvAmm44Nrb+yhiK6p6R9vxVdRBvRf/xbXaNmVoSxzxGqrQHDplpP/xJjxOX5Z3sN5ryhffker5ZSVHqNJ/2j3gfF+2BFl20NLqY1hu0UDmnKgaCx/743z3HzJ0f67Px10VT9mt2l7RGu9DuQXV3WSYysNLI1fRMMX+tFyjnkL1of8xy3v3Y2s2g0Tm91VUQHjrkcX75oE+f0v6UHxgFxCZoIk/eM/cObf5Bf1Ac5bxGWkD5Uwi6aCUtjUm9X4pIxAa40ttvyrxlg4LNhTzW+039Da/RbzX/9HDj42M99WjcqXSWVHXjlgtsnGZ+pIol0Ik8Xrag6nFG74ZNPklHbu+NRDDQfA/riF+NlFNuh/b8FCwF76nLwDH1iZ06llOOofeh2Gbl55KW6E42ODZwtHnwiUZEoi3q6it0sTEIbKT5RvHCMqUy5L1Ev/8YZ8p0T3+RXwUdNGxF5Mew5Tnb8SDjBfiThpzm40DeozUwxYWaQNgXcgdIAAA=",width:1337,height:878}},71218:(t,e,a)=>{t.exports={srcSet:a.p+"images/20190724005-378dcd24.webp 1200w,"+a.p+"images/20190724005-a07e1920.webp 720w,"+a.p+"images/20190724005-7e396ad8.webp 480w",images:[{path:a.p+"images/20190724005-378dcd24.webp",width:1200,height:675},{path:a.p+"images/20190724005-a07e1920.webp",width:720,height:405},{path:a.p+"images/20190724005-7e396ad8.webp",width:480,height:270}],src:a.p+"images/20190724005-378dcd24.webp",toString:function(){return a.p+"images/20190724005-378dcd24.webp"},placeholder:"data:image/webp;base64,UklGRmoBAABXRUJQVlA4IF4BAABQBwCdASooABYAPlEkjUWjoiEStmQ4BQSzgGFZf16f1NNmNr7ctD9+dK4wH26Fgc0WpwnC0dnqnonyC7Jhl+uYv/wAAP7/XJc37l/LM/88DUxXF6eu4wnFpPinrQvgKe+lc65w1oIfqorIZ9wGWD91AzcsHFppOj1XE3qDy+/lQOREIGcjcZ62luqu5jsHvC7F1bEhy6zG+F97s7vnyOhRrtf9oIecg7aW7pDQzRdtkmn28Pb8VFshDHTeJdQKZyk8k0SXbS4N/XzCX6716RL+bxQEQDJGUxzzXtt+QEaIPGfyBzP81HSH3q3UYnonKqxhu+TOPFWOgQc2fudRlZpXiMUwVoe+LVnHWeynGzZBF+jQhEo8e2PBWfIq14hv+hANEA/K137eFk+jd7aoLMI9/n7LZxnwDnoYwH+QAhciTUDW8868oQjBuKvblC5FCAaAEHXiNymY6SFBKYAAAA==",width:1200,height:675}},2229:(t,e,a)=>{t.exports={srcSet:a.p+"images/20191130005-b63212bd.webp 512w,"+a.p+"images/20191130005-e1d49398.webp 480w",images:[{path:a.p+"images/20191130005-b63212bd.webp",width:512,height:512},{path:a.p+"images/20191130005-e1d49398.webp",width:480,height:480}],src:a.p+"images/20191130005-b63212bd.webp",toString:function(){return a.p+"images/20191130005-b63212bd.webp"},placeholder:"data:image/webp;base64,UklGRkQBAABXRUJQVlA4IDgBAAAwBwCdASooACgAPk0ejkQioaGY7M0AKATEtIACiRN8NN1DIuZ4llxOe2TPixSkEhvNdgWiIl9TV4shTrdmaDb58jgA/v1HWto5/EoepMjiojX1e9ed3yWyu+qH3vEEm4xlabenyr99H6l3QlpxAKNDX0HbnTaqSB69Gw4VpQ+9sTVwN0+HsEXJdEfemFwWZtUm2SMAu+0vF/e/CTLn/7UnCFZpyg8E2zRyai6xMjwxDXValCSwmlwofZi0BQfnYepiO3AkJgq1Q3sjqMvqylxKPDxZCGTog7CVnJVLpZO7oRORse2/03r3rdfz5VaHjBqqolpF5FjWX2ewefuQcW9WGt/DbqwrzkGoYmbh9+220DVkF7uT+815FqJRkVwiBFXZ/pHeHM82LuXLhVu5qyc3+z/JaR4AAAA=",width:512,height:512}},99529:(t,e,a)=>{"use strict";a.r(e),a.d(e,{default:()=>r});const s=function(t){var e,s,i=(s=void 0,(e={}).type="post",e.internal=s,e.contentType="markdown",e.slug="better-lazyload-implementation-with-responsive-images",e.content=s,e.createdAt=new Date(156395478e4),e.updatedAt=new Date(156395718e4),e.layout="post",e.title="结合响应式图片实现更好的图片懒加载方案",e.keywords="lazyload,responsive images,图片懒加载,按需延迟加载,响应式图片,前端性能优化",e.description="作为在网页性能调优方面常被使用的技巧之一，懒加载 LazyLoad  或者说延迟加载是在谈及「前端性能优化」话题时不得不说的一项技术。懒加载已经不局限 于单一的图片懒加载，视频、音频等其它媒体资源，甚至组件化 Vue WebComponent 等都已纳入懒加载优化当中。本文探讨了利用 srcset 属性的特性，实现一种相对完美的图片懒加载方案。既能支持响应式图片 Responsive Images，又能完好的实现图片按需加载。",e.date="2019-07-24 15:53:00",e.updated="2019-07-24 16:33:00",e.pageCoverMode="mixed",e.assets={cover:a(71218),featured:a(2229)},e.featured=!0,e.markdownHeadings=[{text:"原理",slug:"原理",level:2},{text:"问题",slug:"问题",level:2},{text:"改进",slug:"改进",level:2},{text:"后记",slug:"后记",level:2},{text:"参考",slug:"参考",level:2}],e.excerpt="<p>作为在网页性能调优方面常被使用的技巧之一，<strong>懒加载</strong>或者说延迟加载是在谈及「前端性能优化」话题时不得不说的一项技术。</p>\n",e.permalink="/blog/better-lazyload-implementation-with-responsive-images",e.attributes=e,e),r=t.options.beforeCreate||[];t.options.beforeCreate=[function(){this.$page=i}].concat(r),["layout","transition"].forEach((function(e){var a=t.options.PageComponent;a&&(t.options[e]=a[e]),void 0===t.options[e]&&(t.options[e]=i[e])})),i.slug&&(t.options.name="page-wrapper-"+i.slug.replace(/[^0-9a-z\-]/gi,"-"))};var i=(0,a(14486).A)({},(function(){var t=this,e=t._self._c;return e("layout-manager",[e("p",[t._v("作为在网页性能调优方面常被使用的技巧之一，"),e("strong",[t._v("懒加载")]),t._v("或者说延迟加载是在谈及「前端性能优化」话题时不得不说的一项技术。")]),t._v(" "),e("blockquote",[e("p",[t._v("延迟加载是一种在加载页面时，延迟加载非关键资源的方法， 而这些非关键资源则在需要时才进行加载。—— "),e("saber-link",{attrs:{to:"https://developers.google.com/web/fundamentals/performance/lazy-loading-guidance/images-and-video/?hl=zh-cn"}},[t._v("Google Deveplopers")])],1)]),t._v(" "),e("p",[t._v("其实说到懒加载，这项技术已经不局限于单一的图片懒加载。除了图片外，懒加载也早就应用到了视频、音频等其它媒体资源的优化上，同时随着组件化思维的不断深化，本着懒加载的核心观点 —— 用户暂时用不到的资源又能延迟去加载的，就大可做成懒加载，WebComponent 也已经纳入到懒加载优化当中，现代前端各种构建工具、类库，都有做相关的优化，进行组件资源的按需加载。本文主要把焦点聚集到“图片”的懒加载处理上，做一番探讨。")]),t._v(" "),e("hr"),t._v(" "),e("h2",{attrs:{id:"原理"}},[t._v("原理")]),t._v(" "),e("p",[t._v("图片懒加载的原理其实非常简单：使用手段让 "),e("code",{pre:!0},[t._v("<img>")]),t._v(" 元素默认只载入非常小的图片内容，再利用 JavaScript 检查元素是否在视口中。 如果元素在视口中，则往其 "),e("code",{pre:!0},[t._v("src")]),t._v("（有时是"),e("code",{pre:!0},[t._v("srcset")]),t._v("）属性中填充真正所需图像内容的地址，加载真正的图片，实现延迟加载。")]),t._v(" "),e("p",[t._v("最早的也是最为有名与流行的实现方式看起来大致如下：")]),t._v(" "),e("div",{pre:!0,attrs:{class:"saber-highlight","data-lang":"html"}},[e("pre",{pre:!0,attrs:{class:"saber-highlight-code language-html"}},[e("code",{pre:!0,attrs:{class:"language-html"}},[t._v('<img src="blank.gif" data-src="normal.jpg" alt="IMG" />')])])]),e("p",[t._v("或者使用 base64 内联：")]),t._v(" "),e("div",{pre:!0,attrs:{class:"saber-highlight","data-lang":"html"}},[e("pre",{pre:!0,attrs:{class:"saber-highlight-code language-html"}},[e("code",{pre:!0,attrs:{class:"language-html"}},[t._v('<img src="data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=" data-src="normal.jpg" />')])])]),e("p",[t._v("更懒的方式甚至会像下面这样省掉占位用的小图，当然这种方式是不被推崇的，留空的 "),e("code",{pre:!0},[t._v("src")]),t._v("\n属性会带来多余的、有害的网络请求"),e("sup",{staticClass:"footnote-ref"},[e("saber-link",{attrs:{id:"fnref1",to:"#fn1"}},[t._v("[1]")])],1),t._v("。你可以完全不写 "),e("code",{pre:!0},[t._v("src")]),t._v(" 属性，这样虽然不符合规范，但是也能工作，但不要留空 "),e("code",{pre:!0},[t._v("src")]),e("sup",{staticClass:"footnote-ref"},[e("saber-link",{attrs:{id:"fnref2",to:"#fn2"}},[t._v("[2]")])],1),t._v("。")]),t._v(" "),e("div",{pre:!0,attrs:{class:"saber-highlight","data-lang":"html"}},[e("pre",{pre:!0,attrs:{class:"saber-highlight-code language-html"}},[e("code",{pre:!0,attrs:{class:"language-html"}},[t._v('<img src="" data-src="normal.jpg" alt="IMG" />')])])]),e("p",[t._v("简单直接是这种方式能成为主流的原因。一张宽高仅有 1px 的透明不可见的 blank.gif，作为默认载入的占位图最合适不过，只有非常小的体积，网页初始化后迅速载入，而真正所需图像的地址被放到了约定的 "),e("code",{pre:!0},[t._v("data-src")]),t._v(" 属性里。当 JavaScript 代码检测到（通过页面载入/\n滚动）图片进入视口时，便将 "),e("code",{pre:!0},[t._v("data-src")]),t._v(" 中的值赋给 "),e("code",{pre:!0},[t._v("src")]),t._v(" 属性，替换掉 blank.gif，触发原始所需图片的加载。但这种简单有力的方式，有些弊端。")]),t._v(" "),e("div",{staticClass:"gad"},[e("adsbygoogle",{attrs:{"ad-layout":"in-article","ad-format":"fluid","ad-slot":"8422573867"}})],1),t._v(" "),e("h2",{attrs:{id:"问题"}},[t._v("问题")]),t._v(" "),e("p",[t._v("首先，其中一个非常直观可见的问题是「"),e("strong",[t._v("布局抖动")]),t._v("」。在图片懒加载时，由于默认载入的\nblank.gif 图片几乎没有大小，真正的图片还没有经过浏览器载入，浏览器就无法确定需要给原始图片预留多大的位置。当真正的图片加载完成后，网页就会出现肉眼可见的布局抖动问题。虽然该问题实际对内容本身没有影响，但影响的是用户体验。")]),t._v(" "),e("Photoswipe",{attrs:{auto:""}},[e("figure",{attrs:{"data-type":"image","data-pswp":"true",itemscope:"",itemprop:"associatedMedia",itemtype:"http://schema.org/ImageObject"}},[e("saber-image",{attrs:{src:a(44219),alt:"布局抖动（图源：Davide Calignano）","data-pswp-title":"布局抖动（图源：Davide Calignano）",loading:"lazy"}}),e("figcaption",[t._v("布局抖动（图源："),e("saber-link",{attrs:{to:"http://davidecalignano.it/lazy-loading-with-responsive-images-and-unknown-height/"}},[t._v("Davide Calignano")]),t._v("）")],1)],1)]),t._v(" "),e("p",[t._v("解决办法是给图片元素设置已知的宽高（元素属性或者 CSS 样式都行），这样浏览器就可以根据宽高预留位置。")]),t._v(" "),e("div",{pre:!0,attrs:{class:"saber-highlight","data-lang":"html"}},[e("pre",{pre:!0,attrs:{class:"saber-highlight-code language-html"}},[e("code",{pre:!0,attrs:{class:"language-html"}},[t._v('<img src="blank.gif" data-src="normal.jpg" style="width:800px;height:600px;" />')])])]),e("p",[t._v("当然固定宽高大小对响应式布局来说不友好，于是就出现了更好的「长宽比盒子」技巧，根据图片宽高计算出图片的长宽比，利用长宽比与 Padding 边距设定占位元素。")]),t._v(" "),e("div",{pre:!0,attrs:{class:"saber-highlight","data-lang":"html"}},[e("pre",{pre:!0,attrs:{class:"saber-highlight-code language-html"}},[e("code",{pre:!0,attrs:{class:"language-html"}},[t._v('<div class="aspect-ratio-box">\n  <img src="blank.gif" data-src="normal.jpg" />\n</div>')])])]),e("div",{pre:!0,attrs:{class:"saber-highlight","data-lang":"css"}},[e("pre",{pre:!0,attrs:{class:"saber-highlight-code language-css"}},[e("code",{pre:!0,attrs:{class:"language-css"}},[t._v(".aspect-ratio-box {\n  position: relative;\n  /* 根据宽高比计算设置 box 的 padding-bottom */\n  padding-bottom: 62.5%;\n}\n\n.aspect-ratio-box img {\n  position: absolute;\n  height: 100%;\n  width: 100%;\n}")])])]),e("p",[t._v("利用长宽比盒子，就能在响应式布局页面中，较好地处理图片懒加载布局抖动的问题。其实更多的长宽比盒子实际用例是用在响应式 video 元素上，关于长宽比盒子技术，可以进一步阅读\nCSS-TRICKS 的文章 —— "),e("saber-link",{attrs:{to:"https://css-tricks.com/aspect-ratio-boxes/"}},[t._v("Aspect Ratio Boxes")]),t._v("。布局抖动解决后样子如下：")],1),t._v(" "),e("Photoswipe",{attrs:{auto:""}},[e("figure",{attrs:{"data-type":"image","data-pswp":"true",itemscope:"",itemprop:"associatedMedia",itemtype:"http://schema.org/ImageObject"}},[e("saber-image",{attrs:{src:a(66900),alt:"占位防抖动（图源：Davide Calignano）","data-pswp-title":"占位防抖动（图源：Davide Calignano）",loading:"lazy"}}),e("figcaption",[t._v("占位防抖动（图源："),e("saber-link",{attrs:{to:"http://davidecalignano.it/lazy-loading-with-responsive-images-and-unknown-height/"}},[t._v("Davide Calignano")]),t._v("）")],1)],1)]),t._v(" "),e("p",[t._v("第二个问题是，这个图片懒加载的最原始实现，"),e("strong",[t._v("没有考虑到响应式图片")]),t._v("（"),e("saber-link",{attrs:{to:"https://www.ruanyifeng.com/blog/2019/06/responsive-images.html"}},[t._v("Responsive Images")]),t._v("）技术的到来。")],1),t._v(" "),e("div",{pre:!0,attrs:{class:"saber-highlight","data-lang":"html"}},[e("pre",{pre:!0,attrs:{class:"saber-highlight-code language-html"}},[e("code",{pre:!0,attrs:{class:"language-html"}},[t._v('<img srcset="small.jpg 100w, middle.jpg 200w, large.jpg 300w" data-src="normal.jpg" />')])])]),e("p",[t._v("不过好在如今的各种 LazyLoad 类库，都已经针对这个问题做了优化，对响应式图片做了兼容。只需要将原来单一图片的 "),e("code",{pre:!0},[t._v("data-src")]),t._v(" 换成多张图的 "),e("code",{pre:!0},[t._v("data-srcset")]),t._v(" 即可。")]),t._v(" "),e("div",{pre:!0,attrs:{class:"saber-highlight","data-lang":"html"}},[e("pre",{pre:!0,attrs:{class:"saber-highlight-code language-html"}},[e("code",{pre:!0,attrs:{class:"language-html"}},[t._v('<img src="blank.gif" data-srcset="small.jpg 100w, middle.jpg 200w, large.jpg 300w" />')])])]),e("p",[t._v("在 "),e("code",{pre:!0},[t._v("data-srcset")]),t._v(" 列出可供懒加载使用的响应式图片，类库就会自动根据终端判断加载哪一张。")]),t._v(" "),e("p",[t._v("第三个问题是一个比较严重的问题，问题的根源在于懒加载中 "),e("code",{pre:!0},[t._v("src")]),t._v(" 属性的 blank.gif 这张占位图本身。为了压缩体积，降低初始载入时间，选用了一张非常小的图。默认载入的这张图虽然在用户浏览站点自身网页时，没什么区别，因为有懒加载脚本加持。但对于站外来说，这张小图带来的影响却是致命的，因为站外访问内容时，没有图片懒加载。")]),t._v(" "),e("p",[t._v("这就产生了严重的弊端，blank.gif 懒加载的方式，"),e("strong",[t._v("对站外 SEO、社会化分享以及 RSS 等稍后阅读工具非常不利")]),t._v("。除了站点自身，几乎所有站外的工具服务，都不会刻意在引用你的内容时，帮你处理懒加载。于是，Google 爬虫爬取你的网页内容时，只会爬到带有 blank.gif\n的“空白” "),e("code",{pre:!0},[t._v("<img>")]),t._v(" 标签，Google 帮你缓存的网页快照，都会是“缺图”的；同时，通过社会化分享功能将内容分享到如 Twitter、Facebook 等站外时，你的内容也会是“无图”的；更惨的是，通过 RSS、Pocket 等稍后阅读工具订阅了你站点内容的读者，他们在阅读工具里无法看到你文章中所有懒加载的图片，阅读工具里有的，只是空空的 blank.gif。")]),t._v(" "),e("Photoswipe",{attrs:{auto:""}},[e("figure",{attrs:{"data-type":"image","data-pswp":"true",itemscope:"",itemprop:"associatedMedia",itemtype:"http://schema.org/ImageObject"}},[e("saber-image",{attrs:{src:a(20320),alt:"RSS 阅读器无法读取懒加载的原图","data-pswp-title":"RSS 阅读器无法读取懒加载的原图",loading:"lazy"}}),e("figcaption",[t._v("RSS 阅读器无法读取懒加载的原图")])],1)]),t._v(" "),e("p",[t._v("于是，问题来了之后就触发了又一次的迭代。尝试修正如下：")]),t._v(" "),e("div",{pre:!0,attrs:{class:"saber-highlight","data-lang":"html"}},[e("pre",{pre:!0,attrs:{class:"saber-highlight-code language-html"}},[e("code",{pre:!0,attrs:{class:"language-html"}},[t._v('<img src="small.jpg" data-src="normal.jpg" />')])])]),e("p",[t._v("最直接的更改，选取一张由原图经过压缩后的 small.jpg 作为懒加载占位图，也就是我们常说的 thumbnail。比如原图的分辨率是 2000x1000，体积是 2MB，经过压缩后的小图是 200x100，体积是 20KB。这样，初始加载这张缩略图仍然会比加载原图快速，同时站外 SEO、RSS 阅读器等也能读取到缩略图勉强解决看不到图的问题。这里我们暂且不谈用压缩的小图替换 blank.gif\n时带来的额外工作量问题 —— 需要对每一张原图生成缩略图。该方案仍然不是一个完美的方案。")]),t._v(" "),e("hr"),t._v(" "),e("h2",{attrs:{id:"改进"}},[t._v("改进")]),t._v(" "),e("p",[t._v("先抛出一个自我打击：如果一直从“先人”创造的最早的图片懒加载方法入手，打死我也不会想到下面这个改进的方案。这里我先直接亮出改进方案的实例：")]),t._v(" "),e("div",{pre:!0,attrs:{class:"saber-highlight","data-lang":"html"}},[e("pre",{pre:!0,attrs:{class:"saber-highlight-code language-html"}},[e("code",{pre:!0,attrs:{class:"language-html"}},[t._v('<div class="aspect-ratio-box" style="padding-bottom:56.25%;">\n  <img\n    src="original.jpg"\n    srcset="thumbnail.jpg"\n    data-srcset="small.jpg 100w, middle.jpg 200w, large.jpg 300w"\n  />\n</div>')])])]),e("p",[t._v("这个改进的图片懒加载方案有包括但不限于以下一些特性：")]),t._v(" "),e("ul",[e("li",[t._v("支持响应式图片（Responsive Images）、支持 webp 格式")]),t._v(" "),e("li",[t._v("对响应式布局友好、支持移动终端屏幕旋转时进行图片大小重绘")]),t._v(" "),e("li",[t._v("使用了 srcset 的特性，在主流的现代浏览器上有完整的支持，同时覆盖率高"),e("sup",{staticClass:"footnote-ref"},[e("saber-link",{attrs:{id:"fnref3",to:"#fn3"}},[t._v("[3]")])],1),t._v(" "),e("ul",[e("li",[t._v("在无法支持 srcset 或者懒加载类库不能生效的旧浏览器上可完美回退（Fallback）")])])]),t._v(" "),e("li",[t._v("对站外 SEO、社会化分享、RSS 稍后阅读等工具服务友好")]),t._v(" "),e("li",[t._v("占位用的缩略图可配置性极强，支持多种 placeholder 展示形式")])]),t._v(" "),e("p",[t._v("以下来说说这个改进方案的魔法之处。还记得最早的图片懒加载方法吗？没错，就是为了避免初始加载原图，"),e("strong",[t._v("刻意")]),t._v("把 "),e("code",{pre:!0},[t._v("src")]),t._v(" 属性的图替换成了空占位图/缩略小图，把原图放到约定的\n"),e("code",{pre:!0},[t._v("data-src")]),t._v(" 属性的旧方法：")]),t._v(" "),e("div",{pre:!0,attrs:{class:"saber-highlight","data-lang":"html"}},[e("pre",{pre:!0,attrs:{class:"saber-highlight-code language-html"}},[e("code",{pre:!0,attrs:{class:"language-html"}},[t._v('<img src="blank.gif" data-src="normal.jpg" />')])])]),e("p",[t._v("既然直接在 "),e("code",{pre:!0},[t._v("src")]),t._v(" 属性上动刀会产生那么多问题，那么有没有什么办法能在不改动 "),e("code",{pre:!0},[t._v("src")]),t._v(" 属性的基础上，通过其它办法避免浏览器初始加载 "),e("code",{pre:!0},[t._v("src")]),t._v(" 属性中的原图，实现懒加载呢？有！下面说一下改进方案的魔术原理。")]),t._v(" "),e("ol",[e("li",[e("p",[t._v("首先，带有 "),e("code",{pre:!0},[t._v(".aspect-ratio-box")]),t._v(" 类选择器的外层 "),e("code",{pre:!0},[t._v("<div>")]),t._v(" 标签，是用来保证懒加载图片在未载入原图时的占位大小的。这个其实是前文说的「长宽比盒子」技巧，解决布局抖动问题，这里没什么特别点。")])]),t._v(" "),e("li",[e("p",[t._v("改进方案中 "),e("code",{pre:!0},[t._v("<img>")]),t._v(" 标签中的 "),e("code",{pre:!0},[t._v("src")]),t._v(" 属性携带的仍然是原始大小的图片 original.jpg，确保了站外 SEO、社会化分享、RSS 等不会读不到原图。"),e("code",{pre:!0},[t._v("src")]),t._v(" 中就是未改动的原图，该读取原图的还是原图。")])]),t._v(" "),e("li",[e("p",[t._v("改进方案中 "),e("code",{pre:!0},[t._v("<img>")]),t._v(" 标签，利用 "),e("code",{pre:!0},[t._v("srcset")]),t._v(" 属性存放了一张缩略图 thumbnail.jpg。正是这张缩略图，有着与 blank.gif 异曲同工的效果 —— 能够阻止 "),e("code",{pre:!0},[t._v("<img>")]),t._v(" 初始化时 "),e("code",{pre:!0},[t._v("src")]),t._v(" 原图被加载。"),e("strong",[t._v("这便是改进方案的关键点")]),t._v("。")])]),t._v(" "),e("li",[e("p",[t._v("最后也是不可或缺的一步，为保证懒加载能正常完成整个逻辑，同时保证对响应式图片的支持，改进方案中 "),e("code",{pre:!0},[t._v("<img>")]),t._v(" 标签将原本应该在 "),e("code",{pre:!0},[t._v("srcset")]),t._v(" 中的响应式图片列表，存放在了约定的 "),e("code",{pre:!0},[t._v("data-srcset")]),t._v(" 中。当图片进入视口时，懒加载类库就会用 "),e("code",{pre:!0},[t._v("data-srcset")]),t._v(" 中的响应式图片地址列表，替换掉实际在 "),e("code",{pre:!0},[t._v("srcset")]),t._v(" 中的缩略图。最后浏览器再根据终端计算判断，选择加载 "),e("code",{pre:!0},[t._v("src")]),t._v(" 属性与 "),e("code",{pre:!0},[t._v("srcset")]),t._v(" 属性中的图片。")])])]),t._v(" "),e("Photoswipe",{attrs:{auto:""}},[e("figure",{attrs:{"data-type":"image","data-pswp":"true",itemscope:"",itemprop:"associatedMedia",itemtype:"http://schema.org/ImageObject"}},[e("saber-image",{attrs:{src:a(71647),alt:"srcset 兼容性（2019 年 7 月）","data-pswp-title":"srcset 兼容性（2019 年 7 月）",loading:"lazy"}}),e("figcaption",[t._v("srcset 兼容性（2019 年 7 月）")])],1)]),t._v(" "),e("p",[t._v("正是通过这么一连串与早期方案截然不同的流程，完美地避开了动刀 "),e("code",{pre:!0},[t._v("src")]),t._v(" 属性产生各种问题的同时，保证了懒加载功能的正常进行。这一切，全得益于 "),e("code",{pre:!0},[t._v("srcset")]),t._v(" 这个神奇的 HTML5 属性，以及其与 "),e("code",{pre:!0},[t._v("src")]),t._v(" 属性以及浏览器三者之间的完好协作。")]),t._v(" "),e("h2",{attrs:{id:"后记"}},[t._v("后记")]),t._v(" "),e("p",[t._v("这么一个突破固有思维的改进方案，当然不是我一下拍脑子能想得出来的，毕竟我还是太菜了，有些东西得继续学习。能了解到这个技巧，全赖「业务是驱动技术发展的主要力量」—— 自从博客更换了系统后，饱受原始图片懒加载方式带来的，布局抖动与 RSS 阅读器不友好的困扰。一直在寻找更好的方案处理博客文章图片的懒加载，直到最近才从谷歌中搜索到 Ivo Petkov\n写的懒加载类库 —— "),e("saber-link",{attrs:{to:"https://github.com/ivopetkov/responsively-lazy/"}},[t._v("responsively-lazy")]),t._v("，并进一步阅读了其相关文章，于是才了解到这么个创新想法。")],1),t._v(" "),e("p",[t._v("在目前能找得到的绝大多数 LazyLoad JS 类库中，基本上都是改 "),e("code",{pre:!0},[t._v("src")]),t._v(" 属性的方案，也就存在改 "),e("code",{pre:!0},[t._v("src")]),t._v(" 产生的问题。Ivo Petkov 的方案真让我耳目一新，只可惜他写的 responsively-lazy\n类库已经很久没有维护了，甚至还有使用老式的 getBoundingClientRect() 办法检测元素的出现，而不是像 "),e("saber-link",{attrs:{to:"https://github.com/ApoorvSaxena/lozad.js"}},[t._v("lozad")]),t._v(" 那样使用精简有力的 IntersectionObserver API。但这并不妨碍新方案本身，创新想法上的发光点。")],1),t._v(" "),e("p",[t._v("如果你还在犹豫是否使用响应式图片、图片懒加载的话，读到这里，就不要犹豫了。快试试吧，还能同时用上呢。")]),t._v(" "),e("h2",{attrs:{id:"参考"}},[t._v("参考")]),t._v(" "),e("p",[t._v("其它前文未曾列出过的参考文章：")]),t._v(" "),e("ul",[e("li",[t._v("Lazy load responsive images - Ivo Petkov"),e("sup",{staticClass:"footnote-ref"},[e("saber-link",{attrs:{id:"fnref4",to:"#fn4"}},[t._v("[4]")])],1)]),t._v(" "),e("li",[t._v("图片懒加载从简单到复杂 - OnionTalk"),e("sup",{staticClass:"footnote-ref"},[e("saber-link",{attrs:{id:"fnref5",to:"#fn5"}},[t._v("[5]")])],1)]),t._v(" "),e("li",[t._v("Sizing Fluid Image Containers with a Little CSS Padding Hack - Andy Shora"),e("sup",{staticClass:"footnote-ref"},[e("saber-link",{attrs:{id:"fnref6",to:"#fn6"}},[t._v("[6]")])],1)])]),t._v(" "),e("hr",{staticClass:"footnotes-sep"}),t._v(" "),e("section",{staticClass:"footnotes"},[e("ol",{staticClass:"footnotes-list"},[e("li",{staticClass:"footnote-item",attrs:{id:"fn1"}},[e("p",[e("saber-link",{attrs:{to:"https://csspod.com/frontend-performance-best-practices/#src"}},[t._v("https://csspod.com/frontend-performance-best-practices/#src")]),t._v(" "),e("saber-link",{staticClass:"footnote-backref",attrs:{to:"#fnref1"}},[t._v("↩︎")])],1)]),t._v(" "),e("li",{staticClass:"footnote-item",attrs:{id:"fn2"}},[e("p",[e("saber-link",{attrs:{to:"https://www.quora.com/Is-it-OK-to-omit-the-src-attribute-from-an-IMG-tag-in-HTML"}},[t._v("https://www.quora.com/Is-it-OK-to-omit-the-src-attribute-from-an-IMG-tag-in-HTML")]),t._v(" "),e("saber-link",{staticClass:"footnote-backref",attrs:{to:"#fnref2"}},[t._v("↩︎")])],1)]),t._v(" "),e("li",{staticClass:"footnote-item",attrs:{id:"fn3"}},[e("p",[e("saber-link",{attrs:{to:"https://caniuse.com/#feat=srcset"}},[t._v("https://caniuse.com/#feat=srcset")]),t._v(" "),e("saber-link",{staticClass:"footnote-backref",attrs:{to:"#fnref3"}},[t._v("↩︎")])],1)]),t._v(" "),e("li",{staticClass:"footnote-item",attrs:{id:"fn4"}},[e("p",[e("saber-link",{attrs:{to:"https://ivopetkov.com/b/lazy-load-responsive-images/"}},[t._v("https://ivopetkov.com/b/lazy-load-responsive-images/")]),t._v(" "),e("saber-link",{staticClass:"footnote-backref",attrs:{to:"#fnref4"}},[t._v("↩︎")])],1)]),t._v(" "),e("li",{staticClass:"footnote-item",attrs:{id:"fn5"}},[e("p",[e("saber-link",{attrs:{to:"https://hateonion.me/posts/19jan30/"}},[t._v("https://hateonion.me/posts/19jan30/")]),t._v(" "),e("saber-link",{staticClass:"footnote-backref",attrs:{to:"#fnref5"}},[t._v("↩︎")])],1)]),t._v(" "),e("li",{staticClass:"footnote-item",attrs:{id:"fn6"}},[e("p",[e("saber-link",{attrs:{to:"https://www.andyshora.com/css-image-container-padding-hack.html"}},[t._v("https://www.andyshora.com/css-image-container-padding-hack.html")]),t._v(" "),e("saber-link",{staticClass:"footnote-backref",attrs:{to:"#fnref6"}},[t._v("↩︎")])],1)])])])],1)}),[],!1,null,null,null);s(i);const r=i.exports},44219:(t,e,a)=>{"use strict";t.exports=a.p+"images/20190724001.770db58f.gif"},66900:(t,e,a)=>{"use strict";t.exports=a.p+"images/20190724002.03ffaba8.gif"}}]);