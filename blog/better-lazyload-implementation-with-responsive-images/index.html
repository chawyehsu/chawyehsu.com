<!DOCTYPE html><html data-saber-ssr lang="zh-cn" data-saber-head="%7B%22lang%22:%7B%22ssr%22:%22zh-cn%22%7D%7D"><head><meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta http-equiv="X-UA-Compatible" content="ie=edge" /><meta data-saber-head="ssr" name="generator" content="Saber v0.14.1"><meta data-saber-head="ssr" name="apple-mobile-web-app-capable" content="yes"><meta data-saber-head="ssr" name="apple-mobile-web-app-status-bar-style" content="default"><meta data-saber-head="ssr" name="mobile-web-app-capable" content="yes"><meta data-saber-head="ssr" name="author" content="Chawye Hsu"><meta data-saber-head="ssr" property="og:type" content="website"><meta data-saber-head="ssr" name="twitter:card" content="summary"><meta data-saber-head="ssr" name="twitter:creator" content="Chawye Hsu"><meta data-saber-head="ssr" name="description" content="作为在网页性能调优方面常被使用的技巧之一，懒加载 LazyLoad  或者说延迟加载是在谈及「前端性能优化」话题时不得不说的一项技术。懒加载已经不局限 于单一的图片懒加载，视频、音频等其它媒体资源，甚至组件化 Vue WebComponent 等都已纳入懒加载优化当中。本文探讨了利用 srcset 属性的特性，实现一种相对完美的图片懒加载方案。既能支持响应式图片 Responsive Images，又能完好的实现图片按需加载。" data-hid="description"><meta data-saber-head="ssr" name="keywords" content="blog,blogger,个人博客,中文独立博客"><meta data-saber-head="ssr" property="og:title" content="结合响应式图片实现更好的图片懒加载方案 - Chawye Hsu"><meta data-saber-head="ssr" property="og:description" content="作为在网页性能调优方面常被使用的技巧之一，懒加载 LazyLoad  或者说延迟加载是在谈及「前端性能优化」话题时不得不说的一项技术。懒加载已经不局限 于单一的图片懒加载，视频、音频等其它媒体资源，甚至组件化 Vue WebComponent 等都已纳入懒加载优化当中。本文探讨了利用 srcset 属性的特性，实现一种相对完美的图片懒加载方案。既能支持响应式图片 Responsive Images，又能完好的实现图片按需加载。"><meta data-saber-head="ssr" name="twitter:title" content="结合响应式图片实现更好的图片懒加载方案 - Chawye Hsu"><meta data-saber-head="ssr" name="twitter:description" content="作为在网页性能调优方面常被使用的技巧之一，懒加载 LazyLoad  或者说延迟加载是在谈及「前端性能优化」话题时不得不说的一项技术。懒加载已经不局限 于单一的图片懒加载，视频、音频等其它媒体资源，甚至组件化 Vue WebComponent 等都已纳入懒加载优化当中。本文探讨了利用 srcset 属性的特性，实现一种相对完美的图片懒加载方案。既能支持响应式图片 Responsive Images，又能完好的实现图片按需加载。"><meta data-saber-head="ssr" property="og:image" content="https://chawyehsu.com/_saber/images/20190724005-193ceac3.webp"><meta data-saber-head="ssr" property="twitter:image:src" content="https://chawyehsu.com/_saber/images/20190724005-193ceac3.webp"> <title>结合响应式图片实现更好的图片懒加载方案 - Chawye Hsu</title> <link data-saber-head="ssr" rel="alternate" title="Chawye Hsu - Feed" href="https://chawyehsu.com/feed/atom.xml" type="application/atom+xml"><link data-saber-head="ssr" href="https://cdn.jsdelivr.net" rel="preconnect" crossorigin="true"><link data-saber-head="ssr" href="https://fonts.googleapis.com" rel="preconnect"><link data-saber-head="ssr" href="https://fonts.gstatic.com" rel="preconnect" crossorigin="true"><link data-saber-head="ssr" href="https://fonts.googleapis.com/css2?family=PT+Sans:ital,wght@0,400;0,700;1,400;1,700&amp;display=swap" rel="stylesheet"><link data-saber-head="ssr" href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&amp;display=swap" rel="stylesheet"><link data-saber-head="ssr" rel="canonical" href="https://chawyehsu.com/blog/better-lazyload-implementation-with-responsive-images"><link rel="stylesheet" href="/_saber/css/styles.5fb89383.css"> <script data-saber-head="ssr">(()=>{const d="dark";const s=localStorage.getItem("user-color-scheme");const p=window.matchMedia("(prefers-color-scheme: dark)").matches;if(!s?p:s===d){const c=document.documentElement.classList;!c.contains(d)&&c.add(d)}})();</script> </head><body><div id="_saber" data-server-rendered="true"><div class="main-container" data-v-243cf42e><aside class="sidebar" data-v-147d1fde data-v-243cf42e><header data-v-147d1fde><div class="logo-outer flex" data-v-147d1fde><a href="/" title="Chawye Hsu" class="inline-block router-link-active" data-v-147d1fde><svg fill="none" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg" class="logo block" data-v-147d1fde><path d="M0 0h512v512H0z" fill="#000" data-v-147d1fde></path> <path d="M39 39h104.423v34.808H39zM431.712 262.154h34.808V471h-34.808zM348.173 349.173h83.538v34.808h-83.538zM313.365 262.154h34.808V471h-34.808z" fill="#fff" data-v-147d1fde></path> <path d="m247.23 296.96h34.808v34.808h-34.808zm-87.019-34.808h87.019v34.808h-87.019zm87.019 139.23h34.808v34.808h-34.808zm-87.019 34.807h87.019v34.808h-87.019zm-34.808-139.23h34.808v139.23h-34.808z" fill="#fff" data-v-147d1fde></path></svg></a></div> <div class="burger-outer" data-v-147d1fde><span class="burger" data-v-147d1fde><span data-v-147d1fde></span> <span data-v-147d1fde></span> <span data-v-147d1fde></span></span></div></header> <div class="navbar" data-v-147d1fde><nav data-v-147d1fde><ul data-v-147d1fde><li data-v-147d1fde><a href="/blog" class="router-link-active" data-v-147d1fde>文章 - Blog</a></li><li data-v-147d1fde><a href="/guestbook" data-v-147d1fde>留言板 - Guestbook</a></li><li data-v-147d1fde><a href="/links" data-v-147d1fde>链接 - Links</a></li><li data-v-147d1fde><a href="/about" data-v-147d1fde>关于 - About</a></li><li data-v-147d1fde><a href="/feed" data-v-147d1fde data-v-147d1fde>订阅 - Subscribe</a></li> <li data-v-147d1fde><div class="navbar-item scheme-switcher" data-v-69d01d4c data-v-147d1fde><span data-v-69d01d4c>ok</span> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon" data-v-69d01d4c><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" data-v-69d01d4c></path></svg> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun" data-v-69d01d4c><circle cx="12" cy="12" r="5" data-v-69d01d4c></circle> <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42" data-v-69d01d4c></path></svg></div></li></ul></nav></div></aside> <main data-v-243cf42e><article role="main" itemscope="itemscope" itemtype="https://schema.org/Article" class="page-content" data-v-243cf42e><header class="page-header" data-v-243cf42e><section class="page-head-content" data-v-243cf42e><h1 class="page-title" data-v-243cf42e>结合响应式图片实现更好的图片懒加载方案</h1> <div class="page-meta" data-v-243cf42e><section class="page-author" data-v-243cf42e><span data-v-243cf42e>Chawye Hsu</span></section> <section class="page-datetime" data-v-243cf42e><time datetime="2019-07-24T07:53:00.000Z" class="published" data-v-243cf42e>
                2019/07/24
              </time></section></div></section></header> <section class="page-body" data-v-243cf42e><p data-v-243cf42e>作为在网页性能调优方面常被使用的技巧之一，<strong data-v-243cf42e>懒加载</strong>或者说延迟加载是在谈及「前端性能优化」话题时不得不说的一项技术。</p> <blockquote data-v-243cf42e><p data-v-243cf42e>延迟加载是一种在加载页面时，延迟加载非关键资源的方法， 而这些非关键资源则在需要时才进行加载。—— <a rel="noopener noreferrer" target="_blank" href="https://developers.google.com/web/fundamentals/performance/lazy-loading-guidance/images-and-video/?hl=zh-cn" data-v-243cf42e>Google Deveplopers</a></p></blockquote> <p data-v-243cf42e>其实说到懒加载，这项技术已经不局限于单一的图片懒加载。除了图片外，懒加载也早就应用到了视频、音频等其它媒体资源的优化上，同时随着组件化思维的不断深化，本着懒加载的核心观点 —— 用户暂时用不到的资源又能延迟去加载的，就大可做成懒加载，WebComponent 也已经纳入到懒加载优化当中，现代前端各种构建工具、类库，都有做相关的优化，进行组件资源的按需加载。本文主要把焦点聚集到“图片”的懒加载处理上，做一番探讨。</p> <hr data-v-243cf42e> <h2 id="原理" data-v-243cf42e>原理</h2> <p data-v-243cf42e>图片懒加载的原理其实非常简单：使用手段让 <code data-v-243cf42e>&lt;img&gt;</code> 元素默认只载入非常小的图片内容，再利用 JavaScript 检查元素是否在视口中。 如果元素在视口中，则往其 <code data-v-243cf42e>src</code>（有时是<code data-v-243cf42e>srcset</code>）属性中填充真正所需图像内容的地址，加载真正的图片，实现延迟加载。</p> <p data-v-243cf42e>最早的也是最为有名与流行的实现方式看起来大致如下：</p> <div class="saber-highlight" data-lang="html" data-v-243cf42e><pre class="saber-highlight-code language-html" data-v-243cf42e><code class="language-html" data-v-243cf42e>&lt;img src=&quot;blank.gif&quot; data-src=&quot;normal.jpg&quot; alt=&quot;IMG&quot; /&gt;</code></pre></div><p data-v-243cf42e>或者使用 base64 内联：</p> <div class="saber-highlight" data-lang="html" data-v-243cf42e><pre class="saber-highlight-code language-html" data-v-243cf42e><code class="language-html" data-v-243cf42e>&lt;img src=&quot;data:image/gif;base64,R0lGODdhAQABAPAAAMPDwwAAACwAAAAAAQABAAACAkQBADs=&quot; data-src=&quot;normal.jpg&quot; /&gt;</code></pre></div><p data-v-243cf42e>更懒的方式甚至会像下面这样省掉占位用的小图，当然这种方式是不被推崇的，留空的 <code data-v-243cf42e>src</code>
属性会带来多余的、有害的网络请求<sup class="footnote-ref" data-v-243cf42e><a href="/blog/better-lazyload-implementation-with-responsive-images#fn1" id="fnref1">[1]</a></sup>。你可以完全不写 <code data-v-243cf42e>src</code> 属性，这样虽然不符合规范，但是也能工作，但不要留空 <code data-v-243cf42e>src</code><sup class="footnote-ref" data-v-243cf42e><a href="/blog/better-lazyload-implementation-with-responsive-images#fn2" id="fnref2">[2]</a></sup>。</p> <div class="saber-highlight" data-lang="html" data-v-243cf42e><pre class="saber-highlight-code language-html" data-v-243cf42e><code class="language-html" data-v-243cf42e>&lt;img src=&quot;&quot; data-src=&quot;normal.jpg&quot; alt=&quot;IMG&quot; /&gt;</code></pre></div><p data-v-243cf42e>简单直接是这种方式能成为主流的原因。一张宽高仅有 1px 的透明不可见的 blank.gif，作为默认载入的占位图最合适不过，只有非常小的体积，网页初始化后迅速载入，而真正所需图像的地址被放到了约定的 <code data-v-243cf42e>data-src</code> 属性里。当 JavaScript 代码检测到（通过页面载入/
滚动）图片进入视口时，便将 <code data-v-243cf42e>data-src</code> 中的值赋给 <code data-v-243cf42e>src</code> 属性，替换掉 blank.gif，触发原始所需图片的加载。但这种简单有力的方式，有些弊端。</p> <div class="gad" data-v-243cf42e><ins data-ad-client="ca-pub-4381515676738667" data-ad-slot="8422573867" data-ad-format="fluid" data-ad-region="page-0.5473822822264991" data-ad-layout="in-article" data-full-width-responsive="false" class="adsbygoogle" style="display:block;"></ins></div> <h2 id="问题" data-v-243cf42e>问题</h2> <p data-v-243cf42e>首先，其中一个非常直观可见的问题是「<strong data-v-243cf42e>布局抖动</strong>」。在图片懒加载时，由于默认载入的
blank.gif 图片几乎没有大小，真正的图片还没有经过浏览器载入，浏览器就无法确定需要给原始图片预留多大的位置。当真正的图片加载完成后，网页就会出现肉眼可见的布局抖动问题。虽然该问题实际对内容本身没有影响，但影响的是用户体验。</p> <Photoswipe auto="" data-v-243cf42e><figure data-type="image" data-pswp="true" itemscope="itemscope" itemprop="associatedMedia" itemtype="http://schema.org/ImageObject" data-v-243cf42e><img alt="布局抖动（图源：Davide Calignano）" data-pswp-title="布局抖动（图源：Davide Calignano）" loading="lazy" src="/_saber/images/20190724001.770db58f.gif"><figcaption data-v-243cf42e>布局抖动（图源：<a rel="noopener noreferrer" target="_blank" href="http://davidecalignano.it/lazy-loading-with-responsive-images-and-unknown-height/" data-v-243cf42e>Davide Calignano</a>）</figcaption></figure></Photoswipe> <p data-v-243cf42e>解决办法是给图片元素设置已知的宽高（元素属性或者 CSS 样式都行），这样浏览器就可以根据宽高预留位置。</p> <div class="saber-highlight" data-lang="html" data-v-243cf42e><pre class="saber-highlight-code language-html" data-v-243cf42e><code class="language-html" data-v-243cf42e>&lt;img src=&quot;blank.gif&quot; data-src=&quot;normal.jpg&quot; style=&quot;width:800px;height:600px;&quot; /&gt;</code></pre></div><p data-v-243cf42e>当然固定宽高大小对响应式布局来说不友好，于是就出现了更好的「长宽比盒子」技巧，根据图片宽高计算出图片的长宽比，利用长宽比与 Padding 边距设定占位元素。</p> <div class="saber-highlight" data-lang="html" data-v-243cf42e><pre class="saber-highlight-code language-html" data-v-243cf42e><code class="language-html" data-v-243cf42e>&lt;div class=&quot;aspect-ratio-box&quot;&gt;
  &lt;img src=&quot;blank.gif&quot; data-src=&quot;normal.jpg&quot; /&gt;
&lt;/div&gt;</code></pre></div><div class="saber-highlight" data-lang="css" data-v-243cf42e><pre class="saber-highlight-code language-css" data-v-243cf42e><code class="language-css" data-v-243cf42e>.aspect-ratio-box {
  position: relative;
  /* 根据宽高比计算设置 box 的 padding-bottom */
  padding-bottom: 62.5%;
}

.aspect-ratio-box img {
  position: absolute;
  height: 100%;
  width: 100%;
}</code></pre></div><p data-v-243cf42e>利用长宽比盒子，就能在响应式布局页面中，较好地处理图片懒加载布局抖动的问题。其实更多的长宽比盒子实际用例是用在响应式 video 元素上，关于长宽比盒子技术，可以进一步阅读
CSS-TRICKS 的文章 —— <a rel="noopener noreferrer" target="_blank" href="https://css-tricks.com/aspect-ratio-boxes/" data-v-243cf42e>Aspect Ratio Boxes</a>。布局抖动解决后样子如下：</p> <Photoswipe auto="" data-v-243cf42e><figure data-type="image" data-pswp="true" itemscope="itemscope" itemprop="associatedMedia" itemtype="http://schema.org/ImageObject" data-v-243cf42e><img alt="占位防抖动（图源：Davide Calignano）" data-pswp-title="占位防抖动（图源：Davide Calignano）" loading="lazy" src="/_saber/images/20190724002.03ffaba8.gif"><figcaption data-v-243cf42e>占位防抖动（图源：<a rel="noopener noreferrer" target="_blank" href="http://davidecalignano.it/lazy-loading-with-responsive-images-and-unknown-height/" data-v-243cf42e>Davide Calignano</a>）</figcaption></figure></Photoswipe> <p data-v-243cf42e>第二个问题是，这个图片懒加载的最原始实现，<strong data-v-243cf42e>没有考虑到响应式图片</strong>（<a rel="noopener noreferrer" target="_blank" href="https://www.ruanyifeng.com/blog/2019/06/responsive-images.html" data-v-243cf42e>Responsive Images</a>）技术的到来。</p> <div class="saber-highlight" data-lang="html" data-v-243cf42e><pre class="saber-highlight-code language-html" data-v-243cf42e><code class="language-html" data-v-243cf42e>&lt;img srcset=&quot;small.jpg 100w, middle.jpg 200w, large.jpg 300w&quot; data-src=&quot;normal.jpg&quot; /&gt;</code></pre></div><p data-v-243cf42e>不过好在如今的各种 LazyLoad 类库，都已经针对这个问题做了优化，对响应式图片做了兼容。只需要将原来单一图片的 <code data-v-243cf42e>data-src</code> 换成多张图的 <code data-v-243cf42e>data-srcset</code> 即可。</p> <div class="saber-highlight" data-lang="html" data-v-243cf42e><pre class="saber-highlight-code language-html" data-v-243cf42e><code class="language-html" data-v-243cf42e>&lt;img src=&quot;blank.gif&quot; data-srcset=&quot;small.jpg 100w, middle.jpg 200w, large.jpg 300w&quot; /&gt;</code></pre></div><p data-v-243cf42e>在 <code data-v-243cf42e>data-srcset</code> 列出可供懒加载使用的响应式图片，类库就会自动根据终端判断加载哪一张。</p> <p data-v-243cf42e>第三个问题是一个比较严重的问题，问题的根源在于懒加载中 <code data-v-243cf42e>src</code> 属性的 blank.gif 这张占位图本身。为了压缩体积，降低初始载入时间，选用了一张非常小的图。默认载入的这张图虽然在用户浏览站点自身网页时，没什么区别，因为有懒加载脚本加持。但对于站外来说，这张小图带来的影响却是致命的，因为站外访问内容时，没有图片懒加载。</p> <p data-v-243cf42e>这就产生了严重的弊端，blank.gif 懒加载的方式，<strong data-v-243cf42e>对站外 SEO、社会化分享以及 RSS 等稍后阅读工具非常不利</strong>。除了站点自身，几乎所有站外的工具服务，都不会刻意在引用你的内容时，帮你处理懒加载。于是，Google 爬虫爬取你的网页内容时，只会爬到带有 blank.gif
的“空白” <code data-v-243cf42e>&lt;img&gt;</code> 标签，Google 帮你缓存的网页快照，都会是“缺图”的；同时，通过社会化分享功能将内容分享到如 Twitter、Facebook 等站外时，你的内容也会是“无图”的；更惨的是，通过 RSS、Pocket 等稍后阅读工具订阅了你站点内容的读者，他们在阅读工具里无法看到你文章中所有懒加载的图片，阅读工具里有的，只是空空的 blank.gif。</p> <Photoswipe auto="" data-v-243cf42e><figure data-type="image" data-pswp="true" itemscope="itemscope" itemprop="associatedMedia" itemtype="http://schema.org/ImageObject" data-v-243cf42e><img alt="RSS 阅读器无法读取懒加载的原图" data-pswp-title="RSS 阅读器无法读取懒加载的原图" loading="lazy" src="/_saber/images/20190724003-8b382a5a.webp" srcset="/_saber/images/20190724003-8b382a5a.webp 657w" width="657" height="252" sizes="(max-width: 768px) 657px"><figcaption data-v-243cf42e>RSS 阅读器无法读取懒加载的原图</figcaption></figure></Photoswipe> <p data-v-243cf42e>于是，问题来了之后就触发了又一次的迭代。尝试修正如下：</p> <div class="saber-highlight" data-lang="html" data-v-243cf42e><pre class="saber-highlight-code language-html" data-v-243cf42e><code class="language-html" data-v-243cf42e>&lt;img src=&quot;small.jpg&quot; data-src=&quot;normal.jpg&quot; /&gt;</code></pre></div><p data-v-243cf42e>最直接的更改，选取一张由原图经过压缩后的 small.jpg 作为懒加载占位图，也就是我们常说的 thumbnail。比如原图的分辨率是 2000x1000，体积是 2MB，经过压缩后的小图是 200x100，体积是 20KB。这样，初始加载这张缩略图仍然会比加载原图快速，同时站外 SEO、RSS 阅读器等也能读取到缩略图勉强解决看不到图的问题。这里我们暂且不谈用压缩的小图替换 blank.gif
时带来的额外工作量问题 —— 需要对每一张原图生成缩略图。该方案仍然不是一个完美的方案。</p> <hr data-v-243cf42e> <h2 id="改进" data-v-243cf42e>改进</h2> <p data-v-243cf42e>先抛出一个自我打击：如果一直从“先人”创造的最早的图片懒加载方法入手，打死我也不会想到下面这个改进的方案。这里我先直接亮出改进方案的实例：</p> <div class="saber-highlight" data-lang="html" data-v-243cf42e><pre class="saber-highlight-code language-html" data-v-243cf42e><code class="language-html" data-v-243cf42e>&lt;div class=&quot;aspect-ratio-box&quot; style=&quot;padding-bottom:56.25%;&quot;&gt;
  &lt;img
    src=&quot;original.jpg&quot;
    srcset=&quot;thumbnail.jpg&quot;
    data-srcset=&quot;small.jpg 100w, middle.jpg 200w, large.jpg 300w&quot;
  /&gt;
&lt;/div&gt;</code></pre></div><p data-v-243cf42e>这个改进的图片懒加载方案有包括但不限于以下一些特性：</p> <ul data-v-243cf42e><li data-v-243cf42e>支持响应式图片（Responsive Images）、支持 webp 格式</li> <li data-v-243cf42e>对响应式布局友好、支持移动终端屏幕旋转时进行图片大小重绘</li> <li data-v-243cf42e>使用了 srcset 的特性，在主流的现代浏览器上有完整的支持，同时覆盖率高<sup class="footnote-ref" data-v-243cf42e><a href="/blog/better-lazyload-implementation-with-responsive-images#fn3" id="fnref3">[3]</a></sup> <ul data-v-243cf42e><li data-v-243cf42e>在无法支持 srcset 或者懒加载类库不能生效的旧浏览器上可完美回退（Fallback）</li></ul></li> <li data-v-243cf42e>对站外 SEO、社会化分享、RSS 稍后阅读等工具服务友好</li> <li data-v-243cf42e>占位用的缩略图可配置性极强，支持多种 placeholder 展示形式</li></ul> <p data-v-243cf42e>以下来说说这个改进方案的魔法之处。还记得最早的图片懒加载方法吗？没错，就是为了避免初始加载原图，<strong data-v-243cf42e>刻意</strong>把 <code data-v-243cf42e>src</code> 属性的图替换成了空占位图/缩略小图，把原图放到约定的
<code data-v-243cf42e>data-src</code> 属性的旧方法：</p> <div class="saber-highlight" data-lang="html" data-v-243cf42e><pre class="saber-highlight-code language-html" data-v-243cf42e><code class="language-html" data-v-243cf42e>&lt;img src=&quot;blank.gif&quot; data-src=&quot;normal.jpg&quot; /&gt;</code></pre></div><p data-v-243cf42e>既然直接在 <code data-v-243cf42e>src</code> 属性上动刀会产生那么多问题，那么有没有什么办法能在不改动 <code data-v-243cf42e>src</code> 属性的基础上，通过其它办法避免浏览器初始加载 <code data-v-243cf42e>src</code> 属性中的原图，实现懒加载呢？有！下面说一下改进方案的魔术原理。</p> <ol data-v-243cf42e><li data-v-243cf42e><p data-v-243cf42e>首先，带有 <code data-v-243cf42e>.aspect-ratio-box</code> 类选择器的外层 <code data-v-243cf42e>&lt;div&gt;</code> 标签，是用来保证懒加载图片在未载入原图时的占位大小的。这个其实是前文说的「长宽比盒子」技巧，解决布局抖动问题，这里没什么特别点。</p></li> <li data-v-243cf42e><p data-v-243cf42e>改进方案中 <code data-v-243cf42e>&lt;img&gt;</code> 标签中的 <code data-v-243cf42e>src</code> 属性携带的仍然是原始大小的图片 original.jpg，确保了站外 SEO、社会化分享、RSS 等不会读不到原图。<code data-v-243cf42e>src</code> 中就是未改动的原图，该读取原图的还是原图。</p></li> <li data-v-243cf42e><p data-v-243cf42e>改进方案中 <code data-v-243cf42e>&lt;img&gt;</code> 标签，利用 <code data-v-243cf42e>srcset</code> 属性存放了一张缩略图 thumbnail.jpg。正是这张缩略图，有着与 blank.gif 异曲同工的效果 —— 能够阻止 <code data-v-243cf42e>&lt;img&gt;</code> 初始化时 <code data-v-243cf42e>src</code> 原图被加载。<strong data-v-243cf42e>这便是改进方案的关键点</strong>。</p></li> <li data-v-243cf42e><p data-v-243cf42e>最后也是不可或缺的一步，为保证懒加载能正常完成整个逻辑，同时保证对响应式图片的支持，改进方案中 <code data-v-243cf42e>&lt;img&gt;</code> 标签将原本应该在 <code data-v-243cf42e>srcset</code> 中的响应式图片列表，存放在了约定的 <code data-v-243cf42e>data-srcset</code> 中。当图片进入视口时，懒加载类库就会用 <code data-v-243cf42e>data-srcset</code> 中的响应式图片地址列表，替换掉实际在 <code data-v-243cf42e>srcset</code> 中的缩略图。最后浏览器再根据终端计算判断，选择加载 <code data-v-243cf42e>src</code> 属性与 <code data-v-243cf42e>srcset</code> 属性中的图片。</p></li></ol> <Photoswipe auto="" data-v-243cf42e><figure data-type="image" data-pswp="true" itemscope="itemscope" itemprop="associatedMedia" itemtype="http://schema.org/ImageObject" data-v-243cf42e><img alt="srcset 兼容性（2019 年 7 月）" data-pswp-title="srcset 兼容性（2019 年 7 月）" loading="lazy" src="/_saber/images/20190724004-d0d0a5bb.webp" srcset="/_saber/images/20190724004-be7d12a4.webp 740w,/_saber/images/20190724004-c644d901.webp 1200w,/_saber/images/20190724004-d0d0a5bb.webp 1337w" width="1337" height="878" sizes="(max-width: 768px) 740px,(max-width: 1920px) 1200px,1337px"><figcaption data-v-243cf42e>srcset 兼容性（2019 年 7 月）</figcaption></figure></Photoswipe> <p data-v-243cf42e>正是通过这么一连串与早期方案截然不同的流程，完美地避开了动刀 <code data-v-243cf42e>src</code> 属性产生各种问题的同时，保证了懒加载功能的正常进行。这一切，全得益于 <code data-v-243cf42e>srcset</code> 这个神奇的 HTML5 属性，以及其与 <code data-v-243cf42e>src</code> 属性以及浏览器三者之间的完好协作。</p> <h2 id="后记" data-v-243cf42e>后记</h2> <p data-v-243cf42e>这么一个突破固有思维的改进方案，当然不是我一下拍脑子能想得出来的，毕竟我还是太菜了，有些东西得继续学习。能了解到这个技巧，全赖「业务是驱动技术发展的主要力量」—— 自从博客更换了系统后，饱受原始图片懒加载方式带来的，布局抖动与 RSS 阅读器不友好的困扰。一直在寻找更好的方案处理博客文章图片的懒加载，直到最近才从谷歌中搜索到 Ivo Petkov
写的懒加载类库 —— <a rel="noopener noreferrer" target="_blank" href="https://github.com/ivopetkov/responsively-lazy/" data-v-243cf42e>responsively-lazy</a>，并进一步阅读了其相关文章，于是才了解到这么个创新想法。</p> <p data-v-243cf42e>在目前能找得到的绝大多数 LazyLoad JS 类库中，基本上都是改 <code data-v-243cf42e>src</code> 属性的方案，也就存在改 <code data-v-243cf42e>src</code> 产生的问题。Ivo Petkov 的方案真让我耳目一新，只可惜他写的 responsively-lazy
类库已经很久没有维护了，甚至还有使用老式的 getBoundingClientRect() 办法检测元素的出现，而不是像 <a rel="noopener noreferrer" target="_blank" href="https://github.com/ApoorvSaxena/lozad.js" data-v-243cf42e>lozad</a> 那样使用精简有力的 IntersectionObserver API。但这并不妨碍新方案本身，创新想法上的发光点。</p> <p data-v-243cf42e>如果你还在犹豫是否使用响应式图片、图片懒加载的话，读到这里，就不要犹豫了。快试试吧，还能同时用上呢。</p> <h2 id="参考" data-v-243cf42e>参考</h2> <p data-v-243cf42e>其它前文未曾列出过的参考文章：</p> <ul data-v-243cf42e><li data-v-243cf42e>Lazy load responsive images - Ivo Petkov<sup class="footnote-ref" data-v-243cf42e><a href="/blog/better-lazyload-implementation-with-responsive-images#fn4" id="fnref4">[4]</a></sup></li> <li data-v-243cf42e>图片懒加载从简单到复杂 - OnionTalk<sup class="footnote-ref" data-v-243cf42e><a href="/blog/better-lazyload-implementation-with-responsive-images#fn5" id="fnref5">[5]</a></sup></li> <li data-v-243cf42e>Sizing Fluid Image Containers with a Little CSS Padding Hack - Andy Shora<sup class="footnote-ref" data-v-243cf42e><a href="/blog/better-lazyload-implementation-with-responsive-images#fn6" id="fnref6">[6]</a></sup></li></ul> <hr class="footnotes-sep" data-v-243cf42e> <section class="footnotes" data-v-243cf42e><ol class="footnotes-list" data-v-243cf42e><li id="fn1" class="footnote-item" data-v-243cf42e><p data-v-243cf42e><a rel="noopener noreferrer" target="_blank" href="https://csspod.com/frontend-performance-best-practices/#src" data-v-243cf42e>https://csspod.com/frontend-performance-best-practices/#src</a> <a href="/blog/better-lazyload-implementation-with-responsive-images#fnref1" class="footnote-backref">↩︎</a></p></li> <li id="fn2" class="footnote-item" data-v-243cf42e><p data-v-243cf42e><a rel="noopener noreferrer" target="_blank" href="https://www.quora.com/Is-it-OK-to-omit-the-src-attribute-from-an-IMG-tag-in-HTML" data-v-243cf42e>https://www.quora.com/Is-it-OK-to-omit-the-src-attribute-from-an-IMG-tag-in-HTML</a> <a href="/blog/better-lazyload-implementation-with-responsive-images#fnref2" class="footnote-backref">↩︎</a></p></li> <li id="fn3" class="footnote-item" data-v-243cf42e><p data-v-243cf42e><a rel="noopener noreferrer" target="_blank" href="https://caniuse.com/#feat=srcset" data-v-243cf42e>https://caniuse.com/#feat=srcset</a> <a href="/blog/better-lazyload-implementation-with-responsive-images#fnref3" class="footnote-backref">↩︎</a></p></li> <li id="fn4" class="footnote-item" data-v-243cf42e><p data-v-243cf42e><a rel="noopener noreferrer" target="_blank" href="https://ivopetkov.com/b/lazy-load-responsive-images/" data-v-243cf42e>https://ivopetkov.com/b/lazy-load-responsive-images/</a> <a href="/blog/better-lazyload-implementation-with-responsive-images#fnref4" class="footnote-backref">↩︎</a></p></li> <li id="fn5" class="footnote-item" data-v-243cf42e><p data-v-243cf42e><a rel="noopener noreferrer" target="_blank" href="https://hateonion.me/posts/19jan30/" data-v-243cf42e>https://hateonion.me/posts/19jan30/</a> <a href="/blog/better-lazyload-implementation-with-responsive-images#fnref5" class="footnote-backref">↩︎</a></p></li> <li id="fn6" class="footnote-item" data-v-243cf42e><p data-v-243cf42e><a rel="noopener noreferrer" target="_blank" href="https://www.andyshora.com/css-image-container-padding-hack.html" data-v-243cf42e>https://www.andyshora.com/css-image-container-padding-hack.html</a> <a href="/blog/better-lazyload-implementation-with-responsive-images#fnref6" class="footnote-backref">↩︎</a></p></li></ol></section></section> <section class="page-comments" data-v-243cf42e><div id="disqus_thread"></div></section></article> <footer data-v-6cb77c8a data-v-243cf42e><div class="container" data-v-6cb77c8a><section class="section" data-v-6cb77c8a><div class="links" data-v-6cb77c8a><ul data-v-6cb77c8a><li data-v-6cb77c8a><a rel="noopener noreferrer" target="_blank" href="https://twitter.com/chawyehsu" data-v-6cb77c8a data-v-6cb77c8a>Twitter</a></li><li data-v-6cb77c8a><a rel="noopener noreferrer" target="_blank" href="https://www.instagram.com/chawyehsu" data-v-6cb77c8a data-v-6cb77c8a>Instagram</a></li><li data-v-6cb77c8a><a href="/legal/privacy" data-v-6cb77c8a>Privacy Policy</a></li></ul></div> <div class="copyright" data-v-6cb77c8a>
        © 2015-2025 Chawye Hsu. Made with <span style="font-family:sans-serif;color:#b30e2e" data-v-6cb77c8a>❤︎</span> in Guangzhou
        <svg version="1.1" viewBox="0 0 100 140" xmlns="http://www.w3.org/2000/svg" class="map-guangzhou" data-v-6cb77c8a><path d="m100 15v0.59q-2.02 0.34-2.81 2.11a0.48 0.48 0 0 1-0.9-0.08l-0.33-1.3a0.36 0.35-24.4 0 0-0.55-0.2l-2.31 1.59q-0.34 0.23-0.49 0.62-0.49 1.24-2.39 1.37c-4.77 0.34-3.89 5.82-8.55 5.75a0.64 0.63 2.9 0 0-0.65 0.58q-0.17 1.72-1.75 2.01-0.66 0.12-0.56 0.79 0.13 0.94-0.62 1.54a0.41 0.41 0 0 0 0.12 0.71l3.66 1.29a0.75 0.75 0 0 1 0.45 0.93q-1.04 3.16 0.86 5.49c1.69 2.09 3.55 4.28 6.38 4.99q0.48 0.11 0.26 0.56l-0.48 0.97a0.46 0.46 0 0 0 0.68 0.58q1.05-0.76 2.38-0.66a0.74 0.74 0 0 1-0.03 1.48q-0.15 0.01-0.3-0.01a1.21 1.2-3.9 0 0-1.33 1.52q0.84 2.94 3.03 1.56a0.37 0.37 0 0 1 0.53 0.47q-1.03 2.22 1 3.25a0.46 0.46 0 0 1 0.01 0.82l-1.29 0.71q-0.64 0.35-0.24 0.96l1.58 2.42a0.53 0.53 0 0 1-0.09 0.67l-0.93 0.87a0.55 0.55 0 0 0 0.01 0.81q0.92 0.8 0.92 1.95 0 0.62-0.61 0.5-2.55-0.48-2.76-2.97-0.06-0.66-0.71-0.78l-4.45-0.78q-0.7-0.13-1.07 0.49-0.54 0.92 0.12 1.84 0.27 0.37 0.18 0.83l-0.96 4.69q-0.12 0.57 0.32 0.95l0.32 0.28a0.97 0.95-63.3 0 1 0.31 0.96q-0.31 1.34 0.69 2.3a0.56 0.56 0 0 1 0.05 0.76l-1.63 2.05a0.54 0.54 0 0 0 0.09 0.75l1.59 1.29a0.5 0.5 0 0 1-0.35 0.88q-4.49-0.28-4.7 4.03a0.55 0.55 0 0 1-0.74 0.49q-3.37-1.24-6.97-0.81a0.95 0.94-33.7 0 1-0.58-0.11l-2-1.14a0.77 0.76 43 0 0-0.78 0.02l-4.35 2.71q-0.49 0.3-1.05 0.12-1.75-0.56-2.27 0.75a0.76 0.76 0 0 1-0.84 0.47q-2.43-0.41-3.78 1.58a0.93 0.93 0 0 1-0.88 0.39c-2.96-0.42-3.64 2.77-5.26 4.64a1.11 1.11 0 0 0-0.26 0.9c0.31 1.88 1.59 3.98 2 5.2 1.46 4.27 2.76 7.13 2.81 11.78q0.01 0.51 0.42 0.82 1.94 1.45 3.24 3.43c2.57 3.91 5.37 7.49 8.22 11.19 3.23 4.21 5.18 8.76 7.49 13.46a0.64 0.63-19.9 0 1-0.42 0.89l-9.8 2.44h-0.57l-3.54-5.17a1.13 1.06-3.9 0 0-0.49-0.4l-4.38-1.81q-0.41-0.17-0.65-0.55l-2.03-3.3q-0.26-0.43-0.13-0.92 0.36-1.29-0.79-1.96-3.91-2.29-6.41-5.43a1.05 1.05 0 0 0-0.75-0.39q-5.12-0.43-8.5-4.3a0.83 0.83 0 0 1 0.42-1.35l1.25-0.32a1.23 1.23 0 0 0-0.58-2.39q-2.5 0.55-4.86-0.37a0.56 0.54 85 0 1-0.29-0.25l-1.7-2.83q-0.19-0.33-0.14-0.72 0.28-1.88-1.46-2.56a0.57 0.56 30.8 0 1-0.23-0.89q0.8-0.94 0.29-2.06a0.53 0.53 0 0 1 0.18-0.65l1.09-0.77a0.59 0.59 0 0 0-0.04-0.99q-1.89-1.08-3.8-2.18-1.14-0.66-0.21-1.99a0.81 0.79-44.3 0 0 0.02-0.88q-0.81-1.31 0.17-2.3a1.49 1.48-72.2 0 0-1.29-2.51q-3.63 0.59-5.99-2.39a0.57 0.57 0 0 1 0.25-0.89l2.76-0.95a0.68 0.68 0 0 0 0.33-1.03l-0.98-1.38q-0.19-0.28-0.02-0.56l0.88-1.43a0.77 0.76 37.5 0 0-0.13-0.96q-0.7-0.64-1.8-0.47a0.87 0.87 0 0 1-0.43-1.68c3.76-1.34 1.3-4.28-1.02-5.49a0.77 0.76 22.9 0 1-0.37-0.9l0.6-1.97q0.16-0.53 0-1.06-0.55-1.8-2.26-2.78-0.4-0.23-0.59-0.66-0.8-1.87-2.56-1.52-0.54 0.11-0.83 0.59-1.21 2-3.66 1.68a0.25 0.24-7.6 0 0-0.26 0.33q1.45 3.58 0.92 4.97a0.44 0.44 0 0 1-0.85-0.25q0.39-1.8-1.41-1.45a0.53 0.53 0 0 1-0.59-0.73q0.8-1.85-0.92-2.78a1.03 1.03 0 0 1-0.54-0.97q0.1-1.49-0.71-2.73a0.6 0.6 0 0 1 0.06-0.73l1.38-1.54q0.6-0.68-0.26-0.97-0.93-0.3-1.41 0.52-0.24 0.41-0.71 0.34c-3.03-0.44-4.12-3.19-2.09-5.55q0.3-0.35 0.08-0.76l-1.36-2.55a0.36 0.35 51.8 0 0-0.57-0.07q-0.95 1.01-1.42 0.47v-0.65q1.59-3.03 4.08-2.2a0.95 0.94-56.2 0 0 0.92-0.19q1.14-1.03 2.67-0.86 0.73 0.08 1.31-0.37l2-1.55a1.88 1.79 21 0 1 0.84-0.35q1.58-0.21 2.65-1.35 0.36-0.4 0.88-0.28c3.56 0.79 5.85-0.53 7.63-3.69a0.56 0.56 0 0 0-0.25-0.78q-1.1-0.51-0.8-1.57 0.14-0.52 0.61-0.79l5.72-3.41a0.43 0.31-54.8 0 1 0.14-0.05q2.77-0.46 1.86-3.1-0.29-0.81 0.54-0.58l1.68 0.48a0.65 0.64 24.4 0 0 0.73-0.27c1.02-1.58 2.08-2.21 2.74-4.03q0.8-2.19 2.24-4.07 0.25-0.34 0.67-0.33 0.43 0.01 0.84 0.26 0.43 0.27 0.93 0.21 3.9-0.49 5.77 3.07 0.23 0.44 0.72 0.58 3.79 1.07 6.24-1.59a0.53 0.53 0 0 1 0.78 0l2.9 3.09a1.07 1.07 0 0 0 1.66-0.13l2.26-3.28q0.25-0.36 0.15-0.78c-0.58-2.62 1.13-4.53-1.85-6.41a0.69 0.69 0 0 1 0.23-1.26q1.66-0.35 1.88-2.12a0.86 0.85-5.2 0 1 0.62-0.73q1.38-0.41 2.65 0.35a0.54 0.53-59.9 0 0 0.74-0.2q0.67-1.22 1.78-0.49a1.04 1.04 0 0 0 1.61-0.76q0.18-1.68-0.84-2.99a0.44 0.44 0 0 1 0.6-0.63q1.69 1.18 3.58 0.48 0.6-0.23 0.89-0.79l1.82-3.42a0.8 0.8 0 0 1 0.87-0.41c3.35 0.68 5.95-4.48 9.83-2.4q0.46 0.25 0.92 0.03 1.16-0.55 2.45-0.2 0.52 0.15 1.02-0.06 3.27-1.38 6.39 0.11 0.48 0.23 0.72 0.71 1.14 2.31 1.33 4.82a1.25 1.23 19.3 0 0 0.4 0.81q1.95 1.72-0.31 3.01a0.99 0.98-14.5 0 0-0.5 0.84q-0.07 3.44 2.06 3.81z" data-v-6cb77c8a></path></svg></div></section></div></footer></main></div></div><script src="/_saber/client.a57f4cd3.js" defer></script></body></html>
